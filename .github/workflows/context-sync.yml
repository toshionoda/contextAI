name: Context Sync (Slack / Google Calendar / Notion)

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ (UTC) â†’ JST ã§ã¯æ¯æ™‚9åˆ†ãšã‚Œã‚‹ãŒå•é¡Œãªã—
    - cron: "0 * * * *"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

env:
  TZ: Asia/Tokyo

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€â”€ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # â”€â”€â”€ Slack åŒæœŸ â”€â”€â”€
      - name: Sync Slack messages
        if: ${{ env.SLACK_BOT_TOKEN != '' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNELS: ${{ secrets.SLACK_CHANNELS }}
        run: python scripts/slack_sync.py
        continue-on-error: true

      # â”€â”€â”€ Google Calendar åŒæœŸ â”€â”€â”€
      - name: Prepare Google credentials
        if: ${{ env.GOOGLE_CLIENT_SECRET != '' }}
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          echo "$GOOGLE_CLIENT_SECRET" > /tmp/credentials.json
          echo "$GOOGLE_TOKEN_JSON" > token.json

      - name: Sync Google Calendar
        if: ${{ env.GOOGLE_CLIENT_SECRET != '' }}
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_CREDENTIALS_PATH: /tmp/credentials.json
        run: python scripts/calendar_sync.py
        continue-on-error: true

      - name: Update token.json if refreshed
        if: ${{ env.GOOGLE_CLIENT_SECRET != '' }}
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          # ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€æ¬¡å›ã®ãŸã‚ã«ä¿å­˜
          if [ -f token.json ]; then
            echo "Token file exists, will be committed if changed"
          fi
        continue-on-error: true

      # â”€â”€â”€ Notion åŒæœŸ â”€â”€â”€
      - name: Sync Notion meetings
        if: ${{ env.NOTION_API_TOKEN != '' }}
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_MEETING_DB_ID: ${{ secrets.NOTION_MEETING_DB_ID }}
        run: python scripts/notion_sync.py
        continue-on-error: true

      # â”€â”€â”€ ã‚¿ã‚¹ã‚¯æŠ½å‡º â”€â”€â”€
      - name: Extract tasks from synced data
        run: python scripts/task_extractor.py
        continue-on-error: true

      # â”€â”€â”€ åŒæœŸãƒ­ã‚°è¨˜éŒ² â”€â”€â”€
      - name: Write sync log
        run: |
          mkdir -p context/daily
          NOW=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M')
          cat > context/daily/last_sync.md << EOF
          # æœ€çµ‚åŒæœŸ: ${NOW} (JST)

          | ã‚½ãƒ¼ã‚¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
          |--------|-----------|
          | Slack | $([ -n "${{ secrets.SLACK_BOT_TOKEN }}" ] && echo "âœ… æœ‰åŠ¹" || echo "âš ï¸ æœªè¨­å®š") |
          | Google Calendar | $([ -n "${{ secrets.GOOGLE_CLIENT_SECRET }}" ] && echo "âœ… æœ‰åŠ¹" || echo "âš ï¸ æœªè¨­å®š") |
          | Notion | $([ -n "${{ secrets.NOTION_API_TOKEN }}" ] && echo "âœ… æœ‰åŠ¹" || echo "âš ï¸ æœªè¨­å®š") |
          EOF

      # â”€â”€â”€ ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥ â”€â”€â”€
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A context/ tasks/

          # token.json ãŒæ›´æ–°ã•ã‚Œã¦ã„ãŸã‚‰è¿½åŠ ï¼ˆ.gitignore ã§é™¤å¤–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          git add token.json 2>/dev/null || true

          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            NOW=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ context sync: ${NOW} (JST)"
            git push
            echo "âœ… Changes pushed"
          fi
